# Citinet — Session Summary 2026-02-22

## What Was Being Tested

A built `citinet.exe` (from this repo) was installed on a second Windows 11 Education machine
to test the hub-joining flow via the Vercel-hosted web client. The hub runs on the dev laptop
with a Cloudflare Quick Tunnel exposing `localhost:9090` publicly. The Vercel web UI
(`citinet.vercel.app` or similar) allows users to enter a hub URL and connect.

---

## Symptoms

- Web UI showed: **"Something went wrong — Connection timed out — hub may not be running yet."**
- Direct browser navigation to the tunnel URL showed: **`ERR_NAME_NOT_RESOLVED`**
- Browser Network tab showed:
  - First `/api/info` request: `(blocked:mixed-content)`
  - Subsequent `/api/info` requests: `(canceled)` after exactly **8.00s**
- `ping -6 2606:4700::6810:e784` → `PING: transmit failed. General failure.`
- `nslookup -type=A [tunnel-url]` → `Non-existent domain`
- `nslookup [tunnel-url]` (default) → resolved to **IPv6-only** Cloudflare addresses via NordVPN DNS (`103.86.96.100`)
- Browser DNS-over-HTTPS: **disabled by MDM policy** ("This setting is turned off for managed browsers")

---

## Root Cause (Confirmed)

**Three-layer problem, all compounding:**

### 1. `trycloudflare.com` Quick Tunnels are IPv6-only
Cloudflare assigns **only AAAA records** (no A records) to quick tunnel subdomains.
`nslookup -type=A` returns `Non-existent domain` — confirmed zero IPv4 DNS entries.

### 2. IPv6 is completely disabled on the test machine
The machine is managed (Windows 11 Education, MDM/Group Policy).
IPv6 is disabled at the OS/adapter level — `ping -6` returns "General failure",
meaning the OS cannot even form an IPv6 packet.

### 3. No fallback path exists
- No A record → no IPv4 route
- IPv6 disabled → can't use AAAA records
- Result: connection is impossible regardless of hub state, firewall, or URL correctness

**The hub itself is fine. The firewall is fine. CORS is fine. The network path does not exist.**

---

## Why It Works on the Dev Laptop

The dev laptop is on a different network/machine without MDM IPv6 restrictions.
It can reach Cloudflare's IPv6 addresses. The hub is also local to that machine.

---

## Things Ruled Out (with evidence)

| Theory | Why Ruled Out |
|---|---|
| Firewall blocking citinet/cloudflared | Firewall screenshot showed both added with All Ports inbound |
| SmartScreen blocking execution | User clicked "Run anyway", app ran successfully (port 9090 confirmed listening) |
| Stale tunnel URL | User confirmed `newman-receivers-pontiac-nelson` was current after rebuild |
| CORS misconfiguration | Hub sets `Access-Control-Allow-Origin: *` unconditionally on all responses |
| Mixed content (http vs https) | Web UI auto-inserts `https://`; first blocked request was a separate issue |
| DNS filtering on network | DNS resolves fine via NordVPN DNS (103.86.96.100) — AAAA records returned |
| Cloudflare bot protection | Server never even receives the request — DNS/IPv6 fails before TCP handshake |

---

## Hub Codebase — Relevant Files

| File | Role |
|---|---|
| `src-tauri/src/hub_api.rs` | axum HTTP server on `0.0.0.0:9090`, CORS middleware, all REST + WebSocket endpoints |
| `src-tauri/src/tunnel_manager.rs` | cloudflared process management, quick tunnel + named tunnel via CF API |
| `src-tauri/src/lib.rs` | Tauri app setup, IPC commands, tunnel watchdog, auto-start |
| `src-tauri/src/storage_manager.rs` | SQLite DB, file I/O, user CRUD |
| `src-tauri/src/auth.rs` | bcrypt, JWT generation/validation |

---

## The Fix

### Why Quick Tunnels Cannot Work on IPv6-Disabled Machines
`trycloudflare.com` subdomains have no A records. Any machine without IPv6 cannot connect.
This is a Cloudflare infrastructure property, not configurable from the hub side.

### Solution: Custom Domain Tunnel

`citinet.cloud` was purchased through Cloudflare Registrar (domain lands on Cloudflare
nameservers automatically, no migration needed). Note: `citinet.io` was purchased earlier
but is blocked pending Cloudflare Trust & Safety review.

**Steps to configure (hub admin panel → Admin → Public Access → Custom Domain):**

1. **Create Cloudflare API Token** at `dash.cloudflare.com/profile/api-tokens`
   - Custom token with:
     - `Account > Cloudflare Tunnel > Edit`
     - `Zone > Zone > Read`
     - `Zone > DNS > Edit`
   - Zone Resources: Include → `citinet.cloud`
   - Account Resources: Include → your account

2. **In hub Admin Panel, fill in:**
   - API Token: *(paste token)*
   - Tunnel Name: `citinet-hub` *(label only)*
   - Hostname: `hub.citinet.cloud`
   - Port: `9090`

3. **Click Set Up Tunnel** — the hub (`tunnel_manager.rs::setup_tunnel`) will:
   - Fetch Cloudflare account ID via API
   - Create a named tunnel (`POST /accounts/{id}/cfd_tunnel`)
   - Configure ingress: `hub.citinet.cloud` → `http://127.0.0.1:9090`
   - Create CNAME DNS record: `hub.citinet.cloud` → `{tunnel-id}.cfargotunnel.com` (proxied)
   - Save tunnel token to SQLite
   - Start tunnel: `cloudflared tunnel run --token {token}`

4. **Result:** `https://hub.citinet.cloud` — permanent URL, never changes on restart,
   Cloudflare proxies over both IPv4 and IPv6, IPv4-only machines connect fine.

---

## Secondary Issue Found (Web Client Bug)

The first `/api/info` fetch showed `(blocked:mixed-content)` in the Network tab.
This means the web client constructs the initial API URL with `http://` despite the
user entering `https://`. The display shows `https://` but the actual fetch uses `http://`.
This is a bug in the **web client repo** (separate from `citinet-client`), not the hub.

**Fix needed in web client:** ensure URL normalization applies `https://` to the
fetch call itself, not just the display string.

---

## Current State Going Into Next Session

- [ ] Complete `citinet.cloud` registration on Cloudflare
- [ ] Create API token with correct permissions
- [ ] Run custom domain tunnel setup in hub admin panel
- [ ] Verify `https://hub.citinet.cloud` resolves with A records (`nslookup -type=A hub.citinet.cloud`)
- [ ] Test connection from IPv6-disabled machine — should work
- [ ] Fix mixed-content bug in web client (first fetch uses `http://` instead of `https://`)
- [ ] Follow up on `citinet.io` Trust & Safety review with Cloudflare
